<!doctype html>
<html>
<head>
<title>日経電子版×クックパッド　データハッカソン</title>
<!-- Copyright 1998-2015 by Northwoods Software Corporation. -->
<script src="/js/go.js"></script>

<script id="code">
  // VARIABLES from app, passing data by jinja
  var NAMES = {{ NAMES|safe }}; // Ingredient names
  var NODE_SIZES = {{ NODE_SIZES|safe }};        // determines the size of the nodes
  var NODE_CATEGORIES = {{ NODE_CATEGORIES|safe }};   // determines the color of the nodes
  var NODE_LINKS = {{ NODE_LINKS|safe }};       // determines the link and link_color rank[n][n]

  function WheelLayout() {
    go.CircularLayout.call(this);
  }
  go.Diagram.inherit(WheelLayout, go.CircularLayout);

  // override makeNetwork to set the diameter of each node and ignore the TextBlock label
  WheelLayout.prototype.makeNetwork = function(coll) {
    var net = go.CircularLayout.prototype.makeNetwork.call(this, coll);
    net.vertexes.each(function(cv) {
      cv.diameter = 20;  // because our desiredSize for nodes is (20, 20)
    });
    return net;
  }

  // override commitNodes to rotate nodes so the text goes away from the center,
  // and flip text if it would be upside-down
  WheelLayout.prototype.commitNodes = function() {
    go.CircularLayout.prototype.commitNodes.call(this);
    this.network.vertexes.each(function(v) {
      var node = v.node;
      if (node === null) return;
      // get the angle of the node towards the center, and rotate it accordingly
      var a = v.actualAngle;
      if (a > 90 && a < 270) {  // make sure the text isn't upside down
        var textBlock = node.findObject("TEXTBLOCK");
        textBlock.angle = 180;
      }
      node.angle = a;
    });
  };
  // end WheelLayout class


  var highlightColor = "red";  // color parameterization

  function init() {
    if (window.goSamples) goSamples();  // init for these samples -- you don't need to call this
    var $ = go.GraphObject.make;  // for conciseness in defining templates

    myDiagram =
      $(go.Diagram, "myDiagram", // must be the ID or reference to div
        {
          autoScale: go.Diagram.Uniform,
          padding: 10,
          contentAlignment: go.Spot.Center,
          layout:
            $(WheelLayout,  // set up a custom CircularLayout
              // set some properties appropriate for this sample
              {
                arrangement: go.CircularLayout.ConstantDistance,
                nodeDiameterFormula: go.CircularLayout.Circular,
                spacing: 10,
                aspectRatio: 1.0,
                sorting: go.CircularLayout.Optimized
              }),
          isReadOnly: true,
          click: function(e) {  // background click clears any remaining highlighteds
            e.diagram.startTransaction("clear");
            e.diagram.clearHighlighteds();
            e.diagram.commitTransaction("clear");
          }
        });

    // define the Node template
    myDiagram.nodeTemplate =
      $(go.Node, "Horizontal",
        {
          selectionAdorned: false,
          locationSpot: go.Spot.Center,  // Node.location is the center of the Shape
          locationObjectName: "SHAPE",
          mouseEnter: function(e, node) {
            node.diagram.clearHighlighteds();
            node.linksConnected.each(function(l) { highlightLink(l, true); });
            node.isHighlighted = true;
            var tb = node.findObject("TEXTBLOCK");
            if (tb !== null) tb.stroke = highlightColor;
          },
          mouseLeave: function(e, node) {
            node.diagram.clearHighlighteds();
            var tb = node.findObject("TEXTBLOCK");
            if (tb !== null) tb.stroke = "black";
          }
        },
        new go.Binding("text", "text"),  // for sorting the nodes
        $(go.Shape, "Ellipse",
          {
            name: "SHAPE",
            fill: "lightgray",  // default value, but also data-bound
            stroke: "transparent",  // modified by highlighting
            strokeWidth: 2,
            desiredSize: new go.Size(20, 20),
            portId: ""
          },  // so links will go to the shape, not the whole node
          new go.Binding("fill", "color"),
          new go.Binding("desiredSize", "desiredSize"),
          new go.Binding("stroke", "isHighlighted",
                         function(h) { return h ? highlightColor : "transparent"; })
                        .ofObject()),
        $(go.TextBlock,
          { name: "TEXTBLOCK" },  // for search
          new go.Binding("text", "text"))
      );

    function highlightLink(link, show) {
      link.isHighlighted = show;
      link.fromNode.isHighlighted = show;
      link.toNode.isHighlighted = show;
    }

    // define the Link template
    myDiagram.linkTemplate =
      $(go.Link,
        {
          routing: go.Link.Normal,
          curve: go.Link.Bezier,
          selectionAdorned: false,
          mouseEnter: function(e, link) { highlightLink(link, true); },
          mouseLeave: function(e, link) { highlightLink(link, false); }
        },
        $(go.Shape,
          new go.Binding("stroke", "isHighlighted",
                         function(h, shape) { return h ? highlightColor : shape.part.data.color; })
                        .ofObject(),
          new go.Binding("strokeWidth", "isHighlighted",
                         function(h) { return h ? 2 : 1; })
                        .ofObject())
      );

    generateGraph();
  }

  function generateGraph() {
    var names = NAMES;
    var colors = NODE_CATEGORIES;
    var sizes = NODE_SIZES;
    var links = NODE_LINKS;

    COLOR = ['red', 'orange', 'yellow', 'green', 'blue', 'lightyellow', 'violet', 'greenyellow']
    var nodeDataArray = [];
    for (var i = 0; i < names.length; i++) {
      // names color and size
      size = Math.floor(sizes[i] * 60 + 1);
      color = colors[i];

      nodeDataArray.push({ key: i, text: names[i], color: COLOR[color],
        desiredSize: new go.Size(size, size) });
    }
    // go.Brush.randomColor(128, 240)

    var linkDataArray = [];
    var num = nodeDataArray.length;
    for (var i = 0; i < num ; i++) {
      for (var j = i; j < num; j++){
        score = links[ i * num + j];

        if( score > 15){
          // links color
          color = score / 20.0;
          linkDataArray.push({ from: i, to: j, color: "rgba(10,200,10," + String(score / 20.0 - 0.3) + ")" });
        }

      }

    }
    //document.write(Math.floor(Math.random() * num));
    //color: go.Brush.randomColor(1, 127)

    myDiagram.model = new go.GraphLinksModel(nodeDataArray, linkDataArray);
  }
</script>
</head>
<body onload="init()">
<!-- BODY -->
<h1>日経電子版×クックパッド　データハッカソン</h1>
<div id="sample">
  <div id="myDiagram" style="border: solid 1px black; background: white; width: 100%; height: 600px" ></div>
</div>
</body>
</html>
